{% extends 'projetos/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Criar Projeto - Sistema de Projetos{% endblock %}

{% block extra_css %}
<style>
    .data-input {
        font-family: 'Courier New', monospace;
        font-size: 1.1em;
        letter-spacing: 1px;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    .data-input:focus {
        background-color: #fff;
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .data-input::placeholder {
        color: #6c757d;
        opacity: 0.7;
    }
    
    .form-text {
        font-size: 0.875em;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .data-input.is-valid {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .data-input.is-invalid {
        border-color: #dc3545;
        background-color: #fff8f8;
    }
    
    .data-input.is-valid:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .data-input.is-invalid:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-folder-plus"></i> Criar Novo Projeto
                </h4>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            {{ form.titulo|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            {{ form.descricao|as_crispy_field }}
                        </div>
                        
                        {% if user.perfil.tipo_usuario not in 'admin,membro' %}
                        <div class="col-12 mb-3">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Atenção:</strong> Apenas administradores e membros podem criar projetos.
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.data_inicio.id_for_label }}" class="form-label">
                                {{ form.data_inicio.label }} <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="{{ form.data_inicio.id_for_label }}" 
                                   name="{{ form.data_inicio.name }}"
                                   placeholder="dd/mm/aaaa"
                                   maxlength="10"
                                   required>
                            <div class="form-text">Digite a data no formato dd/mm/aaaa</div>
                            {% if form.data_inicio.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.data_inicio.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.data_fim.id_for_label }}" class="form-label">
                                {{ form.data_fim.label }} <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="{{ form.data_fim.id_for_label }}" 
                                   name="{{ form.data_fim.name }}"
                                   placeholder="dd/mm/aaaa"
                                   maxlength="10"
                                   required>
                            <div class="form-text">Digite a data no formato dd/mm/aaaa</div>
                            {% if form.data_fim.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.data_fim.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-12 mb-3">
                            {{ form.prioridade|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        {% if equipe_id %}
                            <a href="{% url 'projetos:detalhe-equipe' equipe_id %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </a>
                        {% else %}
                            <a href="{% url 'projetos:lista-projetos' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Voltar
                            </a>
                        {% endif %}
                        {% if user.perfil.tipo_usuario in 'admin,membro' %}
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Criar Projeto
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-secondary" disabled>
                            <i class="bi bi-lock"></i> Sem Permissão
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Dicas para Projetos -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i> Dicas para Projetos
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-check-circle text-success"></i> Boas Práticas</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-arrow-right"></i> Defina objetivos claros</li>
                            <li><i class="bi bi-arrow-right"></i> Estabeleça prazos realistas</li>
                            <li><i class="bi bi-arrow-right"></i> Divida em tarefas menores</li>
                            <li><i class="bi bi-arrow-right"></i> Mantenha comunicação constante</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-gear text-primary"></i> Funcionalidades</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-arrow-right"></i> Quadro Kanban visual</li>
                            <li><i class="bi bi-arrow-right"></i> Sistema de prioridades</li>
                            <li><i class="bi bi-arrow-right"></i> Atribuição de tarefas</li>
                            <li><i class="bi bi-arrow-right"></i> Acompanhamento de progresso</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Script para validação de datas e máscara -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataInicio = document.getElementById('id_data_inicio');
    const dataFim = document.getElementById('id_data_fim');
    
    // Aplicar máscara de data (dd/mm/aaaa)
    function aplicarMascaraData(input) {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é número
            if (value.length > 8) value = value.slice(0, 8);
            
            // Formata a data
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2);
            }
            if (value.length >= 5) {
                value = value.slice(0, 5) + '/' + value.slice(5);
            }
            
            e.target.value = value;
        });
        
        // Permitir apenas números e barra
        input.addEventListener('keypress', function(e) {
            const char = String.fromCharCode(e.which);
            if (!/\d/.test(char) && char !== '/') {
                e.preventDefault();
            }
        });
        
        // Converter formato dd/mm/aaaa para aaaa-mm-dd ao enviar
        input.addEventListener('blur', function() {
            if (this.value && this.value.includes('/')) {
                const partes = this.value.split('/');
                if (partes.length === 3) {
                    const dia = partes[0].padStart(2, '0');
                    const mes = partes[1].padStart(2, '0');
                    const ano = partes[2];
                    
                    // Validar se é uma data válida
                    const data = new Date(ano, mes - 1, dia);
                    if (data.getDate() == dia && data.getMonth() == mes - 1 && data.getFullYear() == ano) {
                        this.value = `${ano}-${mes}-${dia}`;
                        // Adicionar classe de sucesso
                        this.classList.remove('is-invalid');
                        this.classList.add('is-valid');
                    } else {
                        alert('Data inválida! Use o formato dd/mm/aaaa');
                        this.value = '';
                        this.classList.remove('is-valid');
                        this.classList.add('is-invalid');
                    }
                }
            }
        });
    }
    
    // Aplicar máscara aos campos de data
    aplicarMascaraData(dataInicio);
    aplicarMascaraData(dataFim);
    
    // Adicionar estilos aos campos de data
    dataInicio.style.textAlign = 'center';
    dataFim.style.textAlign = 'center';
    
    // Adicionar classe para estilização
    dataInicio.classList.add('data-input');
    dataFim.classList.add('data-input');
    
    // Adicionar tooltips informativos
    dataInicio.title = 'Digite a data no formato dd/mm/aaaa (ex: 29/08/2001)';
    dataFim.title = 'Digite a data no formato dd/mm/aaaa (ex: 11/09/2001)';
    
    // Validação de data fim (deve ser posterior à data início)
    dataFim.addEventListener('change', function() {
        if (this.value && dataInicio.value) {
            const inicio = new Date(dataInicio.value);
            const fim = new Date(this.value);
            
            if (fim < inicio) {
                alert('A data de fim deve ser posterior à data de início.');
                this.value = '';
            }
        }
    });
    
    // Atualizar data mínima de fim quando data início mudar
    dataInicio.addEventListener('change', function() {
        if (this.value) {
            dataFim.min = this.value;
            
            // Se data fim for menor que data início, limpar
            if (dataFim.value && dataFim.value < this.value) {
                dataFim.value = '';
            }
        }
    });
});
</script>
{% endblock %}
